# iDotMatrix

Here we go again.

This time is an iDotMatix device.

This device is a 32 by 32 RGB matrix.  A quick look at the app suggests that this uses the same controller as the iDeal LEDs from last time.  Result if that is true.

Looking at the initial packets says that these are not encrypted.  Let's find out.

## On & Off

Nice and simple this time:
```text
0b000180e70c12010a2610
0500070100
0500070101
0500070100
0500070101
0500070100
0500070101
0500070100
0500070101
0500040101
```

`On` : `05 00 07 01 01`

`Off`: `05 00 07 01 00`

TODO: There is some initialisation to be decoded still.
What does `0b 00 01 80 e7 0c 12 01 0a 26 10` do?

```text
11 0 1 128 231 12 18 1 10 38 16` in decimal.
               |  |  | |  |  |
               |  |  | |  |  L sec
               |  |  | |  L min
               |  |  | L hour
|----| header  |  |  L DOW (Monday)
               |  L day
               L month
            L how is this being convert to year?    Answer: badly.
        L min byte value in Java is -128 so we've lost the sign? Why is this helpful?
```

The year seems to be a straight conversion to a byte.  i.e. decimal 2023 & 0xFF = decimal 231.
So... maybe the year is irrelevant?  I don't imagine it's really needed for anything.



## DIY mode

This lets you draw a pattern on the screen.  You use the app to trace out the pattern and choose the colours.

```text
0a00050100ff00000001
0a00050100ff00000001
0a00050100ff00000003
0a00050100ff00000002
0a00050100ff00000001
...
0a00050100ff00001f1f
0a00050100ff00001e1f
0a00050100ff00001e1e
0a00050100ff00001e1f
0a00050100ff00001f1f
0a00050100ff00001e1f
0a00050100ff00001e1e
0a00050100ff00001e1e
```

This looks pretty easy too.  In fact, I'm going to just assume that this is what I think it is and not do more testing. I started top right and ended bottom left drawing red pixels.

```text
y (starting at zero) ---------------|
x (starting at zero) ------------|  |
blue -------------------------|  |  |
green ---------------------|  |  |  |
red --------------------|  |  |  |  |
header --|------------| |  |  |  |  |
        `0a 00 05 01 00 ff 00 00 1f 1f`
```

Let's write a function to draw a spiral in red in the `idotmatrix_controller.py`.

It works!

## Text

Text looks like it is a bitmap of the whole screen. I will keep a list of discoveries here as I go:

 - The first byte of a long payload is the total length including the length byte (I think)
 - A single line on the display has to have the same colour.  That is, each line must have a colour component for the whole line
 - At font size "32" each character is 16 pixels wide and 32 high
 - It appears that each character of the text is sent as it's own bitmap.  So if you have a string of 5 characters, 5 sets of bitmaps are sent
 - The bitmap format is row major, little endian
 - `plot_hex_grid.py` is capable of decoding the bytes in to a bitmap which looks like it should
 - Java function is perhaps `` public void sendTextTo3232(BleDevice bleDevice, Material material, int i, TextAgreementListener textAgreementListener)``


Handy tool:  http://dotmatrixtool.com/#


```text
0  1  2  3  4  5  6  7  8  9  10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49
32 00 03 00 00 22 00 00 00 c7 7e 90 10 00 00 0c 01 00 00 01 00 00 01 ff 1e 1e 00 00 00 00 02 ff ff ff 00 00 00 00 00 00 00 1c 22 30 2c 22 32 6c 00 00 - hex
50 0 3 0 0 34 0 0 0 199 126 144 16 0 0 12 1 0 0 1 0 0 1 255 30 30 0 0 0 0 2 255 255 255 0 0 0 0 0 0 0 28 34 48 44 34 50 108 0 0 - dec


First byte is length of payload.




320003000022000000db32b57d00000c010000010000012dff160000000002ffffff000000000000001c22302c22326c0000
320003000022000000490bbf6300000c010000010000012161ff0000000002ffffff000000000000001c22302c22326c0000
320003000022000000ccc0b26900000c01000001000001ff16160000000002ffffff000000000000001c22302c22326c0000
320003000022000000bc256f5f00000c0100000100000140ff2d0000000002ffffff000000000000001c22302c22326c0000
320003000022000000dc8b2b0d00000c010000010000012850ff0000000002ffffff000000000000001c22302c22326c0000
```

```text
62000300005200000044aa939300000c01000001000001ffffff0000000005ffffff00000000000000000000c030c030c030e03860186018fe7ffe7f60186018701c300c300cfe7ffe7f300c300c380e180618061806000000000000000000000000
6200030000520000007c2ff67500000c01000001000001ffffff0000000005ffffff00000000000000000000000020102010201020102010fe7ffe7ffe7f100810081008100810081008fe7ffe7ffe7f180c08040804080408040000000000000000
62000300005200000044aa939300000c01000001000001ffffff0000000005ffffff00000000000000000000c030c030c030e03860186018fe7ffe7f60186018701c300c300cfe7ffe7f300c300c380e180618061806000000000000000000000000
ea00030000da00000048582be700000c03000001000001ffffff0000000005ffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff000005ffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff000005ffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff0000
a60003000096000000e713af8000000c02000001000001ffffff0000000005ffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff000005ffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff0000
```

One underscore might be:
`05ffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff0000`

```text
a60003000096000000 871ee21e00000c020000 01000001ff1c1c 0000000005ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff05ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff
a60003000096000000 980e04b100000c020000 010000012eff14 0000000005ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff05ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff
a60003000096000000 defb783f00000c020000 01000001251bff 0000000005ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff05ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff
a60003000096000000 a9c6a01800000c020000 01000001ff0000 0000000005ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff05ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff
a60003000096000000 aa25bade00000c020000 0100000100ff00 0000000005ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff05ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff
a60003000096000000 909480c800000c020000 010000010000ff 0000000005ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff05ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff
a60003000096000000 a9c6a01800000c020000 01000001ff0000 0000000005ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff05ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff
a60003000096000000 aa25bade00000c020000 0100000100ff00 0000000005ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff05ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff
a60003000096000000 909480c800000c020000 010000010000ff 0000000005ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff05ffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffff
a60003000096000000 45d5553500000c020000 010000010000ff 0000000005ffffff0000000000000000000000000000000000000000000000000000fe7f00000000000000000000fe7f00000000000000000000000000000000000000000000000005ffffff0000000000000000000000000000000000000000000000000000fe7f00000000000000000000fe7f000000000000000000000000000000000000000000000000


ea00030000da000000 eb16685e00000c030000 01000001ff0000 0000000005ffffff 00 01 00 0100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000105ffffff0001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000105ffffff00010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001
ea00030000da000000 1dbee5eb00000c030000 0100000100ff00 0000000005ffffff 00 01 00 0100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000105ffffff0001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000105ffffff00010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001
ea00030000da000000 a07982b600000c030000 010000010000ff 0000000005ffffff 00 01 00 0100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000105ffffff0001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000105ffffff00010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001

vertical bar in pos 8 (starting at zero)
620003000052000000 2a ee 2b 46 00000c010000 010000010000ff 0000000005ffffff 00010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001
620003000052000000 63 1f cc 57 00000c010000 010000010000ff 0000000005ffffff 0000000000000000000000000000000000000000000000000000000000000000fe7f000000000000000000000000000000000000000000000000000000000000
620003000052000000 2a ee 2b 46 00000c010000 010000010000ff 0000000005ffffff 00010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001
620003000052000000 2a ee 2b 46 00000c010000 010000010000ff 0000000005ffffff 00010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001

2 vertical bars at 8 and 24

a60003000096000000 5f 54 22 0e 00000c02 0000 0100 0001 0000 ff 0000000005ffffff 000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010 5ffffff 00010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001
a60003000096000000 5f 54 22 0e 00000c02 0000 0100 0001 0000 ff 0000000005ffffff 000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010 5ffffff 00010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001000100010001

A single hash

620003000052000000 32 a4 a8 c5 00000c01 0000 0100 0001 0000 ff 0000000005ffffff 0000 0000 0000 0000 0000 0000 2010 2010 2010 2010 2010 fe7f fe7f fe7f 1008 1008 1008 1008 1008 1008 fe7f fe7f fe7f 180c 0804 0804 0804 0804 0000 0000 0000 0000
```

Ok, code written to decode a single character.  Now to understand the rest of the bytes....

A G and a G scrolling, scrolling full speed:
`62 0003000052000000 93 4d bb 8c 00000c01000001 00 00 010000ff0000000005 ffffff 00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000`
`62 0003000052000000 b6 5b 18 71 00000c01000001 01 00 010000ff0000000005 ffffff 00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000`
`62 0003000052000000 a4 90 c3 84 00000c01000001 01 64 010000ff0000000005 ffffff 00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000`

```text
                             scroll mode 00-08  ||
                                        speed?    ||
                                  colour in here     |||||||||||||||||||
                                        start of chars?                  ||||||
```

speed 100, 50, 25, 50, 75, 100
red, green, blue x 2

```text
62 0003000052000000 a4 90 c3 84 00000c01000001 01 64 01 0000ff 0000000005 ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 3f be f5 0b 00000c01000001 01 32 01 0000ff 0000000005 ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 52 2a d6 a1 00000c01000001 01 19 01 0000ff 0000000005 ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 3f be f5 0b 00000c01000001 01 32 01 0000ff 0000000005 ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 23 74 bf 9f 00000c01000001 01 4b 01 0000ff 0000000005 ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 a4 90 c3 84 00000c01000001 01 64 01 0000ff 0000000005 ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 90 77 8e ba 00000c01000001 01 64 01 ff0000 0000000005 ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 de fc d0 0a 00000c01000001 01 64 01 00ff00 0000000005 ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 a4 90 c3 84 00000c01000001 01 64 01 0000ff 0000000005 ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 90 77 8e ba 00000c01000001 01 64 01 ff0000 0000000005 ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 de fc d0 0a 00000c01000001 01 64 01 00ff00 0000000005 ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 a4 90 c3 84 00000c01000001 01 64 01 0000ff 0000000005 ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
```

changing mode

```text
62 0003000052000000 de fc d0 0a 00000c 0100000101640100ff0000000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 a4 90 c3 84 00000c 010000010164010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 8a ac 57 59 00000c 010000010264010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 af ba f4 a4 00000c 010000010364010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 97 d2 0e 39 00000c 010000010464010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 b2 c4 ad c4 00000c 010000010564010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 9c f8 39 19 00000c 010000010664010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 b9 ee 9a e4 00000c 010000010764010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 ad 2e bc f9 00000c 010000010864010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 81 86 60 79 00000c 010000010064010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 a4 90 c3 84 00000c 010000010164010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 8a ac 57 59 00000c 010000010264010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 af ba f4 a4 00000c 010000010364010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 97 d2 0e 39 00000c 010000010464010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 b2 c4 ad c4 00000c 010000010564010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 9c f8 39 19 00000c 010000010664010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 b9 ee 9a e4 00000c 010000010764010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 ad 2e bc f9 00000c 010000010864010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000
62 0003000052000000 81 86 60 79 00000c 010000010064010000ff00000000 05ffffff00000000000000000000e007f00f381e1c1c1c380c380e380e000e000e000e3f0e3f0e380e380e380e381c381c3c383ef03fe033000000000000000000000000

```

### Mostly decoded text payload

Try and decode the bytes using the Java code:

```text
                         6200 03 00 00 52000000 81866079 0000 0c [16 removed see below] 05ffffff [deleted]
length ------------------|||| |  |  |  |------| |------| |--| |
three ------------------------|  |  |  |      | |      | |  | |
zero ----------------------------|  |  |      | |      | |  | |
maybe continuation marker? if >4096-|  |      | |      | |  | |
some length spanning 4 bytes --------- |------| |------| |  | |
crc32 spanning 4 bytes (char daya and the below)|------| |  | |
if `thing` is 12, then 00,00 else something about time---|--| |
`thing` ------------------------------------------------------|

```

```text
                                    MODE ----|| 
[15 bytes deleted as seen above ] 0100 00 01 00 64 01 00 00 ff 00 00 00 00 05ffffff [deleted]
length of char array (one char)---|||| |  |  || |  |  |  |  |  |  |  |  |  |
zero ----------------------------------|  |  || |  |  |  |  |  |  |  |  |  |
one --------------------------------------|  || |  |  |  |  |  |  |  |  |  |
text mode -----------------------------------|| |  |  |  |  |  |  |  |  |  |
speed ------------------------------------------|  |  |  |  |  |  |  |  |  |
textcolourmode ------------------------------------|  |  |  |  |  |  |  |  |
red   ------------------------------------------------|  |  |  |  |  |  |  |
green   -------------------------------------------------|  |  |  |  |  |  |
blue   -----------------------------------------------------|  |  |  |  |  |
text background col mode --------------------------------------|  |  |  |  |
bg r -------------------------------------------------------------|  |  |  |
bg g ----------------------------------------------------------------|  |  |
bg b -------------------------------------------------------------------|  |
this is the start of a copy of barr2 and is at pos. 14 (start 0) ----------|


some kind of CRC is done.  CRC32 on this array. But the Java looks like it doesn't actually work, which might be why the zero and the one are simply a zero and a one.
Perhaps they were supposed to be a CRC.
```

### multi char
```text
72010300006201000011cf8d0100000c 050000010064010000ff00000000 05 ff ff ff 000000000000000000001c001c001c001c001c001c001c009c0fdc1f7c3c3c383c381c381c381c381c381c381c381c381c381c3800000000000000000000000005ffffff000000000000000000000000000000000000000000000000e007f80f3c1c1c180e38fe3ffe3f0e000e000e381c383c1cf80fe00300000000000000000000000005ffffff0000000000000000000080038003800380038003800380038003800380038003800380038003800380038003800380038003800300000000000000000000000005ffffff0000000000000000000080038003800380038003800380038003800380038003800380038003800380038003800380038003800300000000000000000000000005ffffff000000000000000000000000000000000000000000000000e007f00f381c1c380e700e700e700e700e700e701c38381cf00fe007000000000000000000000000
```

I got as far as trying to work out if 05 ff ff ff is a separator or means something.
